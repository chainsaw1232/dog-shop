<view class="container cart-page">
  <view wx:if="{{isLoading && cartItems.length === 0}}" class="loading-container">
    <text>购物车努力加载中...</text>
  </view>

  <block wx:if="{{!isLoading && !isCartEmpty}}">
    <scroll-view scroll-y class="cart-list-scroll">
      <view class="cart-item" wx:for="{{cartItems}}" wx:key="_id" wx:for-item="item" wx:for-index="index">
        <view class="select-checkbox-container" bindtap="toggleSelect" data-index="{{index}}">
          <image
            class="checkbox-icon"
            src="{{item.selected ? CHOSEN_ICON_PATH : UNCHOSEN_ICON_PATH}}"
          >
          </image>
        </view>
        <image
          class="product-image"
          src="{{item.productImage || '../../static/images/placeholder.png'}}"
          mode="aspectFill"
          bindtap="navigateToDetail"
          data-id="{{item.productId}}"
        >
        </image>
        <view class="product-details-wrapper">
          <text class="product-name" bindtap="navigateToDetail" data-id="{{item.productId}}">{{item.productName}}</text>
          <text class="product-spec" wx:if="{{item.specName}}">{{item.specName}}</text>
          <view class="product-price-actions">
            <text class="product-price">¥{{item.price}}</text>
            <view class="quantity-control">
              <button
                class="quantity-btn minus-btn {{item.quantity <= 1 ? 'disabled-style' : ''}}"
                bindtap="decreaseQuantity"
                data-index="{{index}}"
                disabled="{{item.quantity <= 1}}"
              >-</button>
              <input
                class="quantity-input"
                type="number"
                value="{{item.quantity}}"
                bindinput="onQuantityInput"
                data-index="{{index}}"
                bindblur="onQuantityBlur"
              />
              <button
                class="quantity-btn plus-btn {{item.quantity >= (item.stock || 99) ? 'disabled-style' : ''}}"
                bindtap="increaseQuantity"
                data-index="{{index}}"
                disabled="{{item.quantity >= (item.stock || 99)}}"
              >+</button>
            </view>
          </view>
        </view>
      </view>
    </scroll-view>
  </block>

  <view wx:if="{{!isLoading && isCartEmpty}}" class="empty-cart-container">
    <image class="empty-cart-image" src="cloud://cloud1-2gz5tcgibdf4bfc0.636c-cloud1-2gz5tcgibdf4bfc0-1360056125/images/empty/empty_cart.png" mode="aspectFit"></image>
    <text class="empty-cart-text">购物车还是空的哦，快去给主子挑点好吃的吧！</text>
    <button class="empty-cart-btn" bindtap="navigateToIndex">去逛逛</button>

    <view class="recommend-section" wx:if="{{recommendProducts.length > 0}}">
      <view class="recommend-title-container">
        <view class="line"></view>
        <text class="recommend-title-text">为你推荐</text>
        <view class="line"></view>
      </view>
      <view class="recommend-list">
        <view class="recommend-item" wx:for="{{recommendProducts}}" wx:key="_id" bindtap="navigateToDetail" data-id="{{item._id}}">
          <image
            class="recommend-image"
            src="{{item.mainImage || '../../static/images/placeholder.png'}}"
            mode="aspectFill">
          </image>
          <text class="recommend-name">{{item.name}}</text>
          <text class="recommend-price">¥{{item.price}}</text>
        </view>
      </view>
    </view>
  </view>

  <view class="bottom-bar-grid" wx:if="{{!isCartEmpty || (isLoading && cartItems.length > 0)}}">
    <view class="bottom-bar-cell select-all-cell" bindtap="toggleSelectAll">
      <image
        class="checkbox-icon small-checkbox"
        src="{{allSelected ? CHOSEN_ICON_PATH : UNCHOSEN_ICON_PATH}}"
      >
      </image>
      <text class="select-all-text">全选</text>
    </view>

    <view class="bottom-bar-cell total-price-cell">
      <block wx:if="{{selectedCount > 0}}">
        <view class="total-amount-line">
          <text class="total-label">合计:</text>
          <text class="total-price-value">¥{{totalPrice}}</text>
        </view>
        <text class="shipping-fee-tip">(不含运费)</text>
      </block>
      <block wx:else>
        <text class="total-label-placeholder">未选商品</text>
      </block>
    </view>

    <view class="bottom-bar-cell action-button-cell remove-cell">
      <button
        class="action-btn remove-selected-btn {{selectedCount === 0 ? 'disabled-style' : ''}}"
        bindtap="removeSelectedItems"
        disabled="{{selectedCount === 0 || isSubmitting}}"
      >移除</button>
    </view>

    <view class="bottom-bar-cell action-button-cell checkout-cell">
      <button
        class="action-btn checkout-btn {{selectedCount === 0 ? 'disabled-style' : ''}}"
        bindtap="checkout"
        disabled="{{selectedCount === 0 || isSubmitting}}"
      >结算</button>
    </view>
  </view>
</view>
